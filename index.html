<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>로그인 / 회원가입</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial;
      margin: 0;
      padding: 24px;
    }
    .wrap {
      max-width: 380px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 16px;
      font-size: 20px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .tabs button {
      flex: 1;
      padding: 10px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #f5f5f5;
    }
    .tabs button.active {
      background: #1f6feb;
      color: #fff;
      border-color: #1f6feb;
    }
    form {
      display: grid;
      gap: 10px;
    }
    input, button {
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .primary {
      background: #1f6feb;
      color: #fff;
      border: none;
    }
    .google {
      background: #fff;
      color: #222;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .msg {
      font-size: 13px;
      color: #d00;
      min-height: 18px;
    }
    .hint {
      font-size: 12px;
      color: #666;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>로그인 / 회원가입</h1>

    <div class="tabs">
      <button id="tabLogin" class="active" type="button">로그인</button>
      <button id="tabSignup" type="button">회원가입</button>
    </div>

    <div id="loginView">
      <form id="loginForm" autocomplete="on" novalidate>
        <input id="loginEmail" type="email" inputmode="email" placeholder="이메일" autocomplete="username" required />
        <input id="loginPw" type="password" placeholder="비밀번호" autocomplete="current-password" required />
        <button id="loginBtn" class="primary" type="submit">로그인</button>
        <button id="googleBtn" class="google" type="button" aria-label="Google로 계속">
          <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true">
            <path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.7 32.7 29.3 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.7 1.1 7.7 3l5.7-5.7C34 6.1 29.3 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c10 0 18.4-7.3 19.8-16.8.1-.8.2-1.6.2-2.7 0-1.1-.1-2.1-.4-3z"/>
            <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.6 16.4 19 14 24 14c3 0 5.7 1.1 7.7 3l5.7-5.7C34 6.1 29.3 4 24 4c-7.8 0-14.5 4.4-17.7 10.7z"/>
            <path fill="#4CAF50" d="M24 44c5.2 0 9.9-2 13.4-5.2l-6.2-5.1C29.4 35.9 26.9 37 24 37c-5.2 0-9.6-3.3-11.2-8l-6.6 5C8.3 40 15.6 44 24 44z"/>
            <path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.3 4-5.7 8-11.3 8-5.2 0-9.6-3.3-11.2-8l-6.6 5C8.3 40 15.6 44 24 44c10 0 18.4-7.3 19.8-16.8.1-.8.2-1.6.2-2.7 0-1.1-.1-2.1-.4-3z"/>
          </svg>
          Google로 계속
        </button>
        <div id="loginMsg" class="msg"></div>
      </form>
    </div>

    <div id="signupView" class="hidden">
      <form id="signupForm" autocomplete="on" novalidate>
        <input id="signupEmail" type="email" inputmode="email" placeholder="이메일" required />
        <input id="signupPw" type="password" placeholder="비밀번호(6자 이상 권장)" required />
        <button id="signupBtn" class="primary" type="submit">회원가입</button>
        <div id="signupMsg" class="msg"></div>
        <div class="hint">회원가입 후 인증 메일을 확인하셔야 입장할 수 있어요.</div>
      </form>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCvou9yb-45tI_hdXxUF0_0SSRapvSF080",
      authDomain: "login-1414.firebaseapp.com",
      projectId: "login-1414"
    };

    const REDIRECT_URL = "https://pubgmk14.github.io/Secret/";

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    db.enablePersistence().catch(() => {});

    const $ = (id) => document.getElementById(id);
    const tabLogin = $("tabLogin");
    const tabSignup = $("tabSignup");
    const loginView = $("loginView");
    const signupView = $("signupView");
    const loginForm = $("loginForm");
    const loginBtn = $("loginBtn");
    const loginEmail = $("loginEmail");
    const loginPw = $("loginPw");
    const loginMsg = $("loginMsg");
    const googleBtn = $("googleBtn");
    const signupForm = $("signupForm");
    const signupBtn = $("signupBtn");
    const signupEmail = $("signupEmail");
    const signupPw = $("signupPw");
    const signupMsg = $("signupMsg");

    function showLogin() {
      loginView.classList.remove("hidden");
      signupView.classList.add("hidden");
      tabLogin.classList.add("active");
      tabSignup.classList.remove("active");
      loginMsg.textContent = "";
    }
    function showSignup() {
      signupView.classList.remove("hidden");
      loginView.classList.add("hidden");
      tabSignup.classList.add("active");
      tabLogin.classList.remove("active");
      signupMsg.textContent = "";
    }
    tabLogin.addEventListener("click", showLogin);
    tabSignup.addEventListener("click", showSignup);

    function toMessage(error) {
      const code = error?.code || "";
      if (code.includes("auth/invalid-email")) return "이메일 형식을 확인해 주세요.";
      if (code.includes("auth/missing-password")) return "비밀번호를 입력해 주세요.";
      if (code.includes("auth/weak-password")) return "비밀번호를 더 길게/복잡하게 설정해 주세요.";
      if (code.includes("auth/email-already-in-use")) return "이미 가입된 이메일입니다.";
      if (code.includes("auth/invalid-credential")) return "이메일 또는 비밀번호가 올바르지 않습니다.";
      if (code.includes("auth/user-not-found")) return "가입되지 않은 이메일입니다.";
      if (code.includes("auth/wrong-password")) return "비밀번호가 올바르지 않습니다.";
      if (code.includes("auth/popup-closed-by-user")) return "팝업이 닫혔습니다. 다시 시도해 주세요.";
      if (code.includes("auth/cancelled-popup-request")) return "이전 팝업 작업이 취소되었습니다. 다시 시도해 주세요.";
      return "요청을 처리하지 못했습니다. 잠시 후 다시 시도해 주세요.";
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginBtn.disabled = true;
      loginMsg.textContent = "";
      try {
        const email = loginEmail.value.trim();
        const pw = loginPw.value;
        await auth.signInWithEmailAndPassword(email, pw);
      } catch (err) {
        loginMsg.textContent = toMessage(err);
      } finally {
        loginBtn.disabled = false;
      }
    });

    googleBtn.addEventListener("click", async () => {
      googleBtn.disabled = true;
      loginMsg.textContent = "";
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: "select_account" });
        await auth.signInWithPopup(provider);
      } catch (err) {
        loginMsg.textContent = toMessage(err);
      } finally {
        googleBtn.disabled = false;
      }
    });

    signupForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      signupBtn.disabled = true;
      signupMsg.textContent = "";
      try {
        const email = signupEmail.value.trim();
        const pw = signupPw.value;
        const cred = await auth.createUserWithEmailAndPassword(email, pw);
        await cred.user.sendEmailVerification();
        signupMsg.style.color = "#0a0";
        signupMsg.textContent = "인증 메일을 보냈습니다. 메일함에서 인증 후 로그인해 주세요.";
        await auth.signOut();
        showLogin();
        loginEmail.value = email;
        loginPw.value = "";
      } catch (err) {
        signupMsg.style.color = "#d00";
        signupMsg.textContent = toMessage(err);
      } finally {
        signupBtn.disabled = false;
      }
    });

    auth.onAuthStateChanged(async (user) => {
      if (!user) return;

      const isGoogle = (user.providerData || []).some(p => p.providerId === "google.com");
      try {
        await user.reload();
      } catch {}

      try {
        const userRef = db.collection("users").doc(user.uid);
        const snap = await userRef.get();
        if (!snap.exists) {
          await userRef.set({
            email: user.email,
            provider: isGoogle ? "google" : "password",
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          });
        }
      } catch (e) {
        console.warn("users 문서 생성 실패:", e);
      }

      if (location.href !== REDIRECT_URL) {
        location.replace(REDIRECT_URL);
      }
    });

    [loginEmail, loginPw, signupEmail, signupPw].forEach((el) => {
      el.addEventListener("focus", () => {
        setTimeout(() => el.scrollIntoView({ block: "center", behavior: "smooth" }), 120);
      });
    });
  </script>
</body>
</html>
